# User Devices for Artemis 

## Table of Contents
- [Developer installation](#developer-installation)
- [First configuration](#configuring-the-labscript-suite-for-first-run)
- [Adding a Custom Device to LabScript Suite](#adding-a-custom-device-to-labscript-suite)
- [Simulating the devices Serial port](#simulating-the-devices-serial-port)

---

## Developer installation
1. Create and Activate a Virtual Environment
```bash
mkdir -p ~/labscript-suite
python3.12 -m venv ~/labscript-suite/venv
. ~/labscript-suite/venv/bin/activate
cd ~/labscript-suite
```
2. Install LabScript Suite from GitHub
```bash
pip install --src . -e git+https://github.com/labscript-suite/blacs#egg=blacs
pip install --src . -e git+https://github.com/labscript-suite/labscript#egg=labscript
pip install  --src . -e git+https://github.com/labscript-suite/labscript-devices#egg=labscript-devices
pip install --src . -e git+https://github.com/labscript-suite/labscript-utils#egg=labscript-utils
pip install --src . -e git+https://github.com/labscript-suite/runmanager#egg=runmanager
pip install --src . -e git+https://github.com/labscript-suite/runviewer#egg=runviewer
pip install --src . -e git+https://github.com/labscript-suite/lyse#egg=lyse
```

3. Install  PyQt5 for GUI
```bash
pip install PyQt5
```

4. Create LabScript profile (--> labscript-suite)
```bash
labscript-profile-create
```

5. Install Applications
```bash
desktop-app install blacs lyse runmanager runviewer
```

---
## Configuring the labscript suite for first run
To run all applications, you first need to configure the labconfig/example.ini file generated after creating the LabScript profile. More details can be found in the [LabScript Suite Configuration Guide](https://labscriptsuite.org/en/latest/setup/configuration/).

1. Run Runmanager

- LabScript file: labscript-suite/userlib/labscript/example_apparatus/connection_table.py
- Default shot output folder: labscript_shared/Experiments/example_apparatus/connection_table/

Once you engage the system, .h5 output files will be generated in the specified shot output folder.

2. Synchronize with BLACS

In BLACS, ensure that you run the same connection_table.h5 file that was generated by Runmanager.

---
## Adding a Custom Device to LabScript Suite

1. Navigate to the User Devices Folder: 
```bash 
cd labscript-suite/userlib/user_devices
```
2. Create a new folder for your custom device and navigate into it.
```bash
mkdir MyCustomDevice
cd MyCustomDevice
```

3. Create the following Python files and a markdown file:
``` bash
touch __init__.py BLACS_tabs.py BLACS_workers.py labscript_devices.py register_classes.py MyCustomDevice.md
```

4. Write Code for Your Device:

- Implement the device functionality.
- Add registration code in register_classes.py to integrate your device with the system.
- Provide device documentation in the MyCustomDevice.md file.

5. Modify the connection_table.py file in userlib/labscriptlib/example_apparatus/ to include your new device.

6. Run BLACS with Your New Device: After updating the connection table, start BLACS. You should see a new tab for your custom device.



---

## Simulating the devices Serial port
If you don't have access to the actual device, but want to test your code, you can simulate the device's serial port using provided script in each user_device folder. 

1. Navigate to the Device Directory:
```bash
cd path/to/user_devices/CustomDevice
```
2. Run serial port simulation:
```bash 
python3 emulateSerPort.py
```
3. Interacting with the simulation: Once the script is running, it will provide the simulated serial port (e.g. `/dev/pts/1`), which you can use in your connection table. 
4. Close the simulation when no longer needed (e.g. `Ctrl+C`): It will close the simulated serial port. 

---
## Knowledge gathering
#### Kinds of Devices
- Device: parent class for all devices (labscript.base)
- IntermediateDevice: base class for all devices that are to be clocked by a pseudoclock (labscript.core)

#### Core functions
- generate_code(): should process any instructions the user has added in their labscript code, converting them to the low-level instructions that need to be programmed into the device, and then save those instructions to the shot file.

#### Technical tipps
- controls for devices in BLACS should be labeled with using both the hardware I/O port name 
and a user specified name from the connection table of a labscript file

- serial ports can be listed with: `ls /dev/tty*` , `ls /dev/pts*`
- open serial port can be displayed with: `lsof | grep /dev/pts/X`

---
## Other user_devices

- https://github.com/TU-Darmstadt-APQ/QUIPS_C-Userlib/blob/master/user_devices/Due_AD9910/blacs_tabs.py
- https://github.com/fretchen/synqs_devices/blob/master/SynthHDDevice/blacs_tabs.py
- https://github.com/zakv/RbLab_user_devices/blob/master/elliptec/blacs_workers.py
- https://github.com/naqslab/naqslab_devices/blob/master/README.md
- https://github.com/fretchen/synqs_devices/blob/master/yun_temp/blacs_tabs.py
- https://gitlab.tuwien.ac.at/quantuminfo/experiment-control/labscript-userlib/leolab_devices
